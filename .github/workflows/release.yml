name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'
      
      - name: Build
        run: swift build -v
      
      - name: Run tests
        run: swift test -v
  
  create-release:
    name: Create Release
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Get previous tag
        id: previoustag
        run: |
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          echo "tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ -z "${{ steps.previoustag.outputs.tag }}" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${{ steps.previoustag.outputs.tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ğŸš€ MegaNetworkKit ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸš€ MegaNetworkKit ${{ steps.get_version.outputs.VERSION }}
            
            Swift 6 ê¸°ë°˜ì˜ í˜„ëŒ€ì ì´ê³  íƒ€ì… ì•ˆì „í•œ iOS ë„¤íŠ¸ì›Œí¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
            
            ### ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
            
            #### Swift Package Manager
            ```swift
            dependencies: [
                .package(url: "https://github.com/megastudymobile/ms-networkkit-ios.git", from: "${{ steps.get_version.outputs.VERSION }}")
            ]
            ```
            
            ### âœ¨ ì£¼ìš” ê¸°ëŠ¥
            - Swift 6.0 + Strict Concurrency ì™„ë²½ ì§€ì›
            - Async/Await ê¸°ë°˜ ëª¨ë˜ API
            - Type-Safe í”„ë¡œí† ì½œ ì§€í–¥ ì„¤ê³„
            - Sendable ì¤€ìˆ˜ë¡œ Thread-Safe ë³´ì¥
            - Interceptor ì‹œìŠ¤í…œ (RequestAdapter, ResponseInterceptor, RetryPolicy)
            - iOS 15.0+ ì§€ì›
            
            ### ğŸ“ ë³€ê²½ì‚¬í•­
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ“š ë¬¸ì„œ
            - [README](https://github.com/megastudymobile/ms-networkkit-ios/blob/main/README.md)
            - [ì‚¬ìš© ê°€ì´ë“œ](https://github.com/megastudymobile/ms-networkkit-ios/blob/main/USAGE.md)
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

